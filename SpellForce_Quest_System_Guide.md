# SpellForce Platinum Edition - Quest System Guide

## Table of Contents
1. [Overview](#overview)
2. [Quest System Architecture](#quest-system-architecture)
3. [Core Quest Components](#core-quest-components)
4. [Quest States](#quest-states)
5. [Quest Functions](#quest-functions)
6. [Dialog System](#dialog-system)
7. [Reward System](#reward-system)
8. [Complete Quest Example](#complete-quest-example)
9. [How to Create Your Own Quest](#how-to-create-your-own-quest)

---

## Overview

SpellForce uses a **Lua-based quest scripting system** integrated with NPC dialog and state machines. Quests are managed through:
- **NPC Script Files** (`nXXXX.lua` in `script/P9/` for map P9, etc.)
- **Dialog Trees** (auto-generated sections marked by AllClear exporter)
- **Global Quest System** (`GdsQuestRewards.lua`, `GdsActions.lua`, `GdsConditions.lua`)

Each NPC has a script that defines:
- **State Machine**: Behavior, movement, respawning
- **Dialog Tree**: Conversations with the player
- **Quest Logic**: Conditions, actions, and quest state transitions

---

## Quest System Architecture

### File Structure
```
script/
‚îú‚îÄ‚îÄ P9/                           # Map-specific scripts (Platform 9 = Northern Windwalls)
‚îÇ   ‚îú‚îÄ‚îÄ n2016.lua                # NPC 2016 (Marcia)
‚îÇ   ‚îú‚îÄ‚îÄ n2017.lua                # NPC 2017 (Jonir)
‚îÇ   ‚îú‚îÄ‚îÄ n3258.lua                # NPC 3258 (Gate)
‚îÇ   ‚îî‚îÄ‚îÄ n2016_CutsceneMarciaEntry.lua  # Cutscene script
‚îú‚îÄ‚îÄ GdsActions.lua               # Global action functions
‚îú‚îÄ‚îÄ GdsConditions.lua            # Global condition functions
‚îú‚îÄ‚îÄ GdsQuestRewards.lua          # Quest reward definitions
‚îî‚îÄ‚îÄ GdsDefines.lua               # Global constants

```

### Script Structure Template
```lua
function CreateStateMachine(_Type,_PlatformId,_NpcId,_X,_Y)

BeginDefinition(_Type, _PlatformId, _NpcId, _X, _Y)

-- CUSTOM SCRIPTING SECTION (manually written)
-- State machine behaviors, quest events, flags, etc.

OnIdleGoHome{WalkMode = Walk, X = _X, Y = _Y, Direction = 5}

OnToggleEvent { ... }
OnOneTimeEvent { ... }
Respawn { ... }

--------------------------------------------------------------------------
-- DO NOT EDIT ANYTHING BELOW THIS LINE! ANY CHANGES WILL BE LOST!
--------------------------------------------------------------------------
-- Script file created by AllClear -> Lua exporter 1.1
-- Source: C:\project\main\mission\dialoge\pX\nXXXX_Name.txt

-- AUTO-GENERATED DIALOG SECTION (generated by AllClear tool)

OnBeginDialog{ ... }
OnAnswer{ ... }

EndDefinition()
end
```

---

## Core Quest Components

### 1. Quest States

SpellForce quests have **4 states**:

| State | Constant | Description |
|-------|----------|-------------|
| **Unknown** | `StateUnknown` | Quest not yet discovered |
| **Active** | `StateActive` | Quest accepted and in progress |
| **Solved** | `StateSolved` | Quest completed successfully |
| **Failed** | `StateFailed` | Quest failed (rare) |

### 2. Quest IDs

Quests are referenced by **numeric IDs** (e.g., `QuestId = 116`).

**Example Quest IDs from Northern Windwalls (P9)**:
- `112` - Dwarf Gate Access
- `114` - Iron Wagons Collection
- `116` - Defend Brunnenfels
- `117` - Battle at Brunnenfels
- `118` - Unknown Quest
- `120` - Battle Victory
- `121` - Brunnenfels Saved
- `122` - Hokan Ashir Investigation
- `124` - Journey to Dwarf Lands
- `125` - Find Skarvig
- `126` - Entry to Northern Windwalls
- `127` - Unknown Quest
- `452` - Unlock Dwarf Gate
- `464`, `465`, `468` - Other quests

---

## Quest Functions

### Quest Actions (from `GdsActions.lua`)

#### `QuestBegin{QuestId = X}`
**Purpose**: Starts a quest (changes state from Unknown to Active)

**Example**:
```lua
QuestBegin{QuestId = 116}  -- Start "Defend Brunnenfels" quest
```

#### `QuestSolve{QuestId = X}`
**Purpose**: Completes a quest (changes state from Active to Solved)

**Example**:
```lua
QuestSolve{QuestId = 452}  -- Complete "Unlock Dwarf Gate" quest
```

#### `QuestFail{QuestId = X}` *(inferred)*
**Purpose**: Fails a quest (rare, not seen in examples)

---

### Quest Conditions (from `GdsConditions.lua`)

#### `QuestState{QuestId = X, State = Y, UpdateInterval = Z}`
**Purpose**: Check if a quest is in a specific state

**Parameters**:
- `QuestId`: Quest ID number
- `State`: `StateUnknown`, `StateActive`, `StateSolved`, `StateFailed`
- `UpdateInterval`: How often to check (in game steps, 10 = 1 second)

**Examples**:
```lua
-- Check if quest 116 is active
QuestState{QuestId = 116, State = StateActive}

-- Check if quest 121 is NOT unknown (i.e., discovered)
Negated(QuestState{QuestId = 121, State = StateUnknown})

-- Check if quest 120 is solved (with polling every 1.5 seconds)
QuestState{QuestId = 120, State = StateSolved, UpdateInterval = 15}
```

---

## Dialog System

### Dialog Structure

Dialogs are defined using:
- **`OnBeginDialog`**: Initial greeting (can have multiple variants based on conditions)
- **`OnAnswer`**: Player response branches (identified by `AnswerId`)

### Dialog Functions

#### `OnBeginDialog{Conditions = {...}, Actions = {...}}`
**Purpose**: Define what NPC says when dialog starts

**Example**:
```lua
OnBeginDialog{
    Conditions = {
        IsPlayerFlagFalse{Name = "FlagJonirKnown"},
    },
    Actions = {
        Say{Tag = "jonir001", String = "The Rune fights under my banner..."},
        Answer{Tag = "jonir001PC", String = "I have no choice, my Lord!", AnswerId = 1},
    }
}
```

#### `OnAnswer{AnswerId; Conditions = {...}, Actions = {...}}`
**Purpose**: Define dialog branches based on player choices

**Example**:
```lua
OnAnswer{4;  -- This is answer #4
    Conditions = {},
    Actions = {
        Say{Tag = "marcia004", String = "Hokan Ashir? Indeed... He was a mage of the Circle."},
        Answer{Tag = "", String = "", AnswerId = 5},  -- Continue to answer 5
    }
}
```

### Dialog Actions

| Action | Purpose | Example |
|--------|---------|---------|
| `Say{}` | NPC speaks | `Say{Tag = "npc001", String = "Hello!"}` |
| `Answer{}` | End of dialog node | `Answer{Tag = "", String = "", AnswerId = 2}` |
| `OfferAnswer{}` | Player choice | `OfferAnswer{Tag = "pc001", String = "Tell me more", AnswerId = 3}` |
| `EndDialog{}` | Close dialog window | `EndDialog()` |

---

## Reward System

### Reward Structure (from `GdsQuestRewards.lua`)

Rewards are defined in **platform-specific tables**:

```lua
QuestRewardsP9 = 
{
    Marcia1 = { XP = {150} },
    SchlachtUmBrunnenfels2 = { XP = {150}, Items = {708, 545} },
    Eisenkarren1 = { XP = {20} },
}
```

### Reward Types

| Type | Format | Example |
|------|--------|---------|
| **Experience** | `XP = {amount}` | `XP = {150}` |
| **Items** | `Items = {id1, id2}` | `Items = {708, 545}` |
| **Money** | `Money = {Gold = X, Silver = Y, Copper = Z}` | `Money = {Gold = 5, Silver = 10}` |

### Applying Rewards

Rewards are triggered using flags:

```lua
SetRewardFlagTrue{Name = "Marcia1"}
```

The reward system automatically grants the reward defined in `QuestRewardsP9["Marcia1"]`.

---

## Complete Quest Example

### Quest: "Unlock the Dwarf Gate" (Quest ID 452)

**Location**: Northern Windwalls (Platform P9)  
**NPC**: Gate (n3258.lua)  
**Objective**: Use the Dwarf Gate Key (Item 3228) to open the gate

#### Script: `n3258.lua`

```lua
function CreateStateMachine(_Type,_PlatformId,_NpcId,_X,_Y)

BeginDefinition(_Type, _PlatformId, _NpcId, _X, _Y)

-- Portal/Gate Control
OnPortalEvent
{
    UpdateInterval = 15,
    X = 122, Y = 231,           -- Gate position
    Type = StadtTor,            -- City gate type
    OpenConditions = { 
        IsGlobalFlagTrue{Name = "Q112DwarfGateUnlocked", UpdateInterval = 15}
    },
    CloseConditions = {},
    StayOpen = TRUE,            -- Never closes once opened
}

--------------------------------------------------------------------------
-- AUTO-GENERATED DIALOG SECTION
--------------------------------------------------------------------------

-- Initial interaction
OnBeginDialog{
    Conditions = {},
    Actions = {
        Say{Tag = "gatenwalls001", String = "(The gate is locked. The lock is ornate and of dwarven craft.)"},
        Answer{Tag = "", String = "", AnswerId = 1},
    }
}

-- Check if player has key
OnAnswer{1;
    Conditions = {
        PlayerHasItem{ItemId = 3228},  -- Dwarf Gate Key
    },
    Actions = {
        Say{Tag = "", String = ""},
        OfferAnswer{Tag = "gatenwalls001PC", String = "(Use the Dwarf Gate Key.)", AnswerId = 2},
    }
}

-- Player doesn't have key
OnAnswer{1;
    Conditions = {
        Negated(PlayerHasItem{ItemId = 3228}),
    },
    Actions = {
        Say{Tag = "", String = ""},
    }
}

-- Player uses key
OnAnswer{2;
    Conditions = {},
    Actions = {
        Say{Tag = "gatenwalls002", String = "(The key fits. The gate opens.)"},
        Answer{Tag = "", String = "", AnswerId = 3},
    }
}

-- Complete quest and remove key
OnAnswer{3;
    Conditions = {},
    Actions = {
        RemoveDialogFromNpc{NpcId = 3258},                      -- No more dialog
        TransferItem{TakeItem = 3228, Amount = 1, Flag = Take}, -- Remove key
        SetGlobalFlagTrue{Name = "Q112DwarfGateUnlocked"},      -- Open gate
        QuestSolve{QuestId = 452},                              -- Complete quest
        Say{Tag = "", String = ""},
        Answer{Tag = "", String = "", AnswerId = 4},
    }
}

-- End dialog
OnAnswer{4;
    Conditions = {},
    Actions = {
        EndDialog(),
    }
}

EndDefinition()
end
```

#### Key Mechanics:

1. **Gate State**: Controlled by `OnPortalEvent` listening to flag `Q112DwarfGateUnlocked`
2. **Dialog Check**: Verifies player has Item 3228 (key)
3. **Quest Completion**: Uses `QuestSolve{QuestId = 452}`
4. **Item Removal**: `TransferItem{TakeItem = 3228, Amount = 1, Flag = Take}`
5. **One-Time Use**: `RemoveDialogFromNpc{}` prevents re-interaction

---

## How to Create Your Own Quest

### Step-by-Step Guide

#### 1. **Plan Your Quest**

Define:
- **Quest ID**: Choose unused number (check existing quests)
- **Objective**: What must the player do?
- **NPCs Involved**: Who gives/completes the quest?
- **Rewards**: XP, items, money
- **Prerequisites**: Previous quests, items, flags

**Example Quest Concept**:
```
Quest ID: 999
Name: "The Lost Sword"
Giver: Blacksmith (NPC 5000)
Objective: Find the Lost Sword (Item 4000) and return it
Reward: 200 XP, 500 Gold
```

---

#### 2. **Create Quest Giver NPC Script**

Create file: `script/P9/n5000.lua`

```lua
function CreateStateMachine(_Type,_PlatformId,_NpcId,_X,_Y)

BeginDefinition(_Type, _PlatformId, _NpcId, _X, _Y)

-- NPC Behavior
OnIdleGoHome{WalkMode = Walk, X = _X, Y = _Y, Direction = 2}
Respawn{WaitTime = 60}

-- Quest Management: Enable dialog when quest becomes active
OnToggleEvent
{
    OnConditions = {
        QuestState{QuestId = 999, State = StateUnknown}  -- Quest not started
    },
    OnActions = {
        EnableDialog{}
    },
    OffConditions = {
        QuestState{QuestId = 999, State = StateActive}   -- Quest started
    },
    OffActions = {
        SetDialogType{Type = SideQuest}
    },
}

-- Remove dialog after quest complete
OnOneTimeEvent
{
    Conditions = {
        QuestState{QuestId = 999, State = StateSolved}
    },
    Actions = {
        RemoveDialog{}
    }
}

--------------------------------------------------------------------------
-- DIALOG SECTION
--------------------------------------------------------------------------

-- Initial greeting (quest not started)
OnBeginDialog{
    Conditions = {
        QuestState{QuestId = 999, State = StateUnknown}
    },
    Actions = {
        Say{Tag = "blacksmith001", String = "Traveler! I need your help!"},
        Answer{Tag = "", String = "", AnswerId = 1},
    }
}

-- Offer quest
OnAnswer{1;
    Conditions = {},
    Actions = {
        Say{Tag = "blacksmith002", String = "My grandfather's sword was stolen by orcs! Can you retrieve it?"},
        OfferAnswer{Tag = "blacksmith002PC_yes", String = "I'll find it.", AnswerId = 2},
        OfferAnswer{Tag = "blacksmith002PC_no", String = "Not right now.", AnswerId = 99},
    }
}

-- Accept quest
OnAnswer{2;
    Conditions = {},
    Actions = {
        QuestBegin{QuestId = 999},  -- START QUEST
        RevealUnExplored{X = 300, Y = 400, Range = 15},  -- Reveal orc camp location
        Say{Tag = "blacksmith003", String = "Thank you! The orcs were last seen near the old ruins."},
        Answer{Tag = "", String = "", AnswerId = 3},
    }
}

-- End dialog
OnAnswer{3;
    Conditions = {},
    Actions = {
        EndDialog(),
    }
}

-- Decline quest
OnAnswer{99;
    Conditions = {},
    Actions = {
        Say{Tag = "blacksmith004", String = "Please reconsider!"},
        EndDialog(),
    }
}

-- Quest in progress (player returns without sword)
OnBeginDialog{
    Conditions = {
        QuestState{QuestId = 999, State = StateActive},
        Negated(PlayerHasItem{ItemId = 4000})  -- Don't have sword
    },
    Actions = {
        Say{Tag = "blacksmith005", String = "Have you found my sword?"},
        Answer{Tag = "blacksmith005PC", String = "Not yet.", AnswerId = 10},
    }
}

OnAnswer{10;
    Conditions = {},
    Actions = {
        EndDialog(),
    }
}

-- Quest complete (player has sword)
OnBeginDialog{
    Conditions = {
        QuestState{QuestId = 999, State = StateActive},
        PlayerHasItem{ItemId = 4000}  -- Has the sword!
    },
    Actions = {
        Say{Tag = "blacksmith006", String = "You found it! You're amazing!"},
        Answer{Tag = "blacksmith006PC", String = "Here's your sword.", AnswerId = 20},
    }
}

OnAnswer{20;
    Conditions = {},
    Actions = {
        TransferItem{TakeItem = 4000, Amount = 1, Flag = Take},  -- Remove sword
        QuestSolve{QuestId = 999},  -- COMPLETE QUEST
        SetRewardFlagTrue{Name = "LostSwordReward"},  -- Grant reward
        Say{Tag = "blacksmith007", String = "Thank you! Take this as payment."},
        Answer{Tag = "", String = "", AnswerId = 21},
    }
}

OnAnswer{21;
    Conditions = {},
    Actions = {
        EndDialog(),
    }
}

EndDefinition()
end
```

---

#### 3. **Add Quest Reward**

Edit: `script/GdsQuestRewards.lua`

Find the section for your map (e.g., `QuestRewardsP9`) and add:

```lua
QuestRewardsP9 = 
{
    -- ... existing rewards ...
    
    LostSwordReward = { XP = {200}, Money = {Gold = 5} },
}
```

---

#### 4. **Create Sword Spawn Trigger**

Create file: `script/P9/n5001.lua` (for sword item spawn)

```lua
function CreateStateMachine(_Type,_PlatformId,_NpcId,_X,_Y)

BeginDefinition(_Type, _PlatformId, _NpcId, _X, _Y)

-- Invisible NPC that spawns the sword when quest is active
OnIdleGoHome{WalkMode = Walk, X = _X, Y = _Y, Direction = 0}

-- Spawn sword once quest is active
OnOneTimeEvent
{
    Conditions = {
        QuestState{QuestId = 999, State = StateActive}
    },
    Actions = {
        -- Spawn sword on ground at orc camp
        Spawn{X = 310, Y = 405, UnitId = 4000, NotPersistant = FALSE},
        Vanish{}  -- This NPC disappears after spawning sword
    }
}

EndDefinition()
end
```

**Alternative**: Place the sword as a **lootable object** on an Orc Chief:

```lua
-- In Orc Chief script (e.g., n5002.lua)
OnOneTimeEvent
{
    Conditions = {
        FigureDead{NpcId = 5002}  -- Orc Chief dies
    },
    Actions = {
        -- Spawn sword at death location
        Spawn{X = 310, Y = 405, UnitId = 4000}
    }
}
```

---

#### 5. **Test Your Quest**

1. **Load Map**: Start game and travel to the map
2. **Find NPC**: Talk to blacksmith (NPC 5000)
3. **Accept Quest**: Choose "I'll find it"
4. **Check Quest Log**: Quest 999 should appear as active
5. **Find Sword**: Go to revealed location, get Item 4000
6. **Return**: Talk to blacksmith again
7. **Complete Quest**: Hand over sword, receive reward

---

### Advanced Quest Techniques

#### Multi-Objective Quests

Use **multiple conditions**:

```lua
OnBeginDialog{
    Conditions = {
        QuestState{QuestId = 100, State = StateActive},
        PlayerHasItem{ItemId = 1000},  -- Objective 1
        PlayerHasItem{ItemId = 1001},  -- Objective 2
        IsGlobalFlagTrue{Name = "Q100_EnemyDefeated"},  -- Objective 3
    },
    Actions = {
        QuestSolve{QuestId = 100},  -- All objectives met
        -- ... rewards ...
    }
}
```

#### Quest Chains

Link quests together:

```lua
-- Quest 1 completion starts Quest 2
OnAnswer{10;
    Conditions = {},
    Actions = {
        QuestSolve{QuestId = 100},
        QuestBegin{QuestId = 101},  -- Start next quest
    }
}
```

#### Conditional Rewards

```lua
-- Better reward if completed quickly
OnAnswer{10;
    Conditions = {
        IsGlobalFlagTrue{Name = "Q100_CompletedFast"}
    },
    Actions = {
        SetRewardFlagTrue{Name = "Quest100BonusReward"},
    }
}

OnAnswer{10;
    Conditions = {
        IsGlobalFlagFalse{Name = "Q100_CompletedFast"}
    },
    Actions = {
        SetRewardFlagTrue{Name = "Quest100NormalReward"},
    }
}
```

#### Timed Quests

```lua
-- Quest must be completed before evening
OnToggleEvent
{
    OnConditions = {
        QuestState{QuestId = 200, State = StateActive},
        TimeNight()  -- It's now night
    },
    OnActions = {
        QuestFail{QuestId = 200},  -- Fail quest
        SetGlobalFlagTrue{Name = "Q200_Failed"}
    }
}
```

---

## Common Quest Patterns

### 1. **Fetch Quest** (Bring item to NPC)
```lua
Conditions = {
    QuestState{QuestId = X, State = StateActive},
    PlayerHasItem{ItemId = Y}
}
Actions = {
    TransferItem{TakeItem = Y, Amount = 1, Flag = Take},
    QuestSolve{QuestId = X},
    SetRewardFlagTrue{Name = "RewardName"}
}
```

### 2. **Kill Quest** (Defeat enemy)
```lua
OnOneTimeEvent
{
    Conditions = {
        QuestState{QuestId = X, State = StateActive},
        FigureDead{NpcId = EnemyId}
    },
    Actions = {
        SetGlobalFlagTrue{Name = "QX_EnemyDead"}
    }
}
```

### 3. **Escort Quest** (Protect NPC)
```lua
OnOneTimeEvent
{
    Conditions = {
        QuestState{QuestId = X, State = StateActive},
        FigureInRange{NpcId = EscortNpc, X = DestX, Y = DestY, Range = 5},
        FigureAlive{NpcId = EscortNpc}
    },
    Actions = {
        QuestSolve{QuestId = X}
    }
}
```

### 4. **Exploration Quest** (Reach location)
```lua
OnOneTimeEvent
{
    Conditions = {
        QuestState{QuestId = X, State = StateActive},
        FigureInRange{NpcId = 0, X = TargetX, Y = TargetY, Range = 10}
    },
    Actions = {
        QuestSolve{QuestId = X}
    }
}
```

---

## Quest API Reference

### Actions

| Function | Parameters | Description |
|----------|-----------|-------------|
| `QuestBegin` | `QuestId` | Start quest |
| `QuestSolve` | `QuestId` | Complete quest |
| `QuestFail` | `QuestId` | Fail quest |
| `SetGlobalFlagTrue` | `Name` | Set global flag |
| `SetGlobalFlagFalse` | `Name` | Unset global flag |
| `SetPlayerFlagTrue` | `Name` | Set player flag |
| `SetNpcFlagTrue` | `Name` | Set NPC flag |
| `SetRewardFlagTrue` | `Name` | Grant quest reward |
| `TransferItem` | `TakeItem`, `GiveItem`, `Amount`, `Flag` | Give/take items |
| `TransferResource` | `Resource`, `Amount`, `Side`, `Flag` | Give/take resources |
| `RevealUnExplored` | `X`, `Y`, `Range` | Reveal map area |
| `EnableDialog` | `NpcId` | Enable NPC dialog |
| `RemoveDialog` | `NpcId` | Disable NPC dialog |
| `SetDialogType` | `Type` | `MainQuest` or `SideQuest` |

### Conditions

| Function | Parameters | Description |
|----------|-----------|-------------|
| `QuestState` | `QuestId`, `State`, `UpdateInterval` | Check quest state |
| `PlayerHasItem` | `ItemId`, `Amount`, `Equipment` | Player has item |
| `PlayerHasNotItem` | `ItemId` | Player doesn't have item |
| `FigureAlive` | `NpcId` | NPC is alive |
| `FigureDead` | `NpcId` | NPC is dead |
| `FigureInRange` | `NpcId`, `X`, `Y`, `Range` | Figure near position |
| `IsGlobalFlagTrue` | `Name` | Global flag is set |
| `IsGlobalFlagFalse` | `Name` | Global flag not set |
| `IsPlayerFlagTrue` | `Name` | Player flag is set |
| `IsNpcFlagTrue` | `Name` | NPC flag is set |
| `BuildingInRange` | `X`, `Y`, `Range`, `Owner` | Building exists |
| `TimeOfDay` | `Hour`, `Minute`, `TimeFrame` | Check game time |
| `Negated` | `Condition` | Invert condition |
| `UND` | `Cond1`, `Cond2` | AND logic (both true) |

---

## Tips and Best Practices

### 1. **Use Unique Quest IDs**
Never reuse quest IDs. Search existing scripts first:
```bash
grep -r "QuestId = 999" script/
```

### 2. **Use Descriptive Flag Names**
```lua
-- Good
SetGlobalFlagTrue{Name = "Q999_SwordReturned"}

-- Bad
SetGlobalFlagTrue{Name = "flag1"}
```

### 3. **Test Quest Failure Cases**
What if player:
- Drops the quest item?
- Kills the quest NPC?
- Leaves the map?

### 4. **Use UpdateInterval Wisely**
```lua
-- Fast check (10 steps = 1 second) - expensive!
QuestState{QuestId = 100, State = StateActive, UpdateInterval = 10}

-- Slow check (60 steps = 6 seconds) - better for most cases
QuestState{QuestId = 100, State = StateActive, UpdateInterval = 60}
```

### 5. **Always Test Multiplayer**
Quest flags may behave differently in co-op mode.

### 6. **Document Your Quests**
Add comments:
```lua
-- QUEST 999: The Lost Sword
-- Giver: Blacksmith (NPC 5000)
-- Objectives: Find sword (Item 4000) from orc camp
-- Reward: 200 XP, 5 Gold
```

---

## Troubleshooting

### Quest Won't Start
- Check `QuestBegin{QuestId = X}` is called
- Verify quest ID is unique
- Check NPC dialog conditions

### Quest Won't Complete
- Verify all conditions are met
- Check `QuestSolve{QuestId = X}` is called
- Test with debug flags

### Reward Not Granted
- Check reward name matches `GdsQuestRewards.lua`
- Verify `SetRewardFlagTrue{Name = "..."}` is called
- Check reward table for correct map

### Dialog Broken
- Check `OnBeginDialog` conditions
- Verify `AnswerId` numbers are unique
- Check for syntax errors in Lua

---

## Conclusion

SpellForce's quest system is **powerful and flexible**:
- ‚úÖ Event-driven architecture
- ‚úÖ Branching dialog trees
- ‚úÖ State machine integration
- ‚úÖ Flexible reward system
- ‚úÖ Moddable and extensible

With this guide, you can create:
- Simple fetch quests
- Complex multi-objective quests
- Quest chains and storylines
- Dynamic world events

**Happy Quest Scripting!** üéÆ‚öîÔ∏è

---

## Additional Resources

### Useful Files to Study
1. `script/GdsActions.lua` - All action functions
2. `script/GdsConditions.lua` - All condition functions
3. `script/GdsQuestRewards.lua` - Reward definitions
4. `script/P9/n2016.lua` - Marcia (main quest NPC)
5. `script/P9/n2017.lua` - Jonir (complex dialog example)
6. `script/P9/n3258.lua` - Gate (item-based quest)

### Lua Syntax Reminder
SpellForce uses **Lua 4.0**:
- Tables: `{key = value}`
- Arrays: `{1, 2, 3}` (1-indexed)
- Functions: `function Name(params) ... end`
- Comments: `-- single line` or `--[[ multi line ]]`

### Testing Commands
Use console commands (if available):
```lua
-- Set quest state
SetQuestState(999, StateActive)

-- Check quest state
print(GetQuestState(999))

-- Add item
GiveItem(4000, 1)
```

---

**Document Version**: 1.0  
**Last Updated**: 2025-01-21  
**Author**: SpellForce Modding Community
